<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pedidos en Vivo - VALÚ Chocobananas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f3f4f6; }
        .order-card { transition: all 0.3s ease; }
        .order-card.new { animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        /* Modal Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background: white; padding: 2rem; border-radius: 1rem; width: 90%; max-width: 500px; text-align: center; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-screen-xl mx-auto">
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 bg-white p-4 rounded-lg shadow">
            <h1 class="text-3xl font-bold text-gray-800 mb-4 md:mb-0">Dashboard de Pedidos</h1>
            <div class="flex items-center gap-4">
                <div class="text-center">
                    <div class="text-sm text-gray-500">Ventas Totales del Día</div>
                    <div id="total-sales" class="text-2xl font-bold text-green-600">$0.00</div>
                </div>
                <button id="export-pdf-btn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors" disabled>Exportar PDF</button>
                <button id="close-shift-btn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors">Cerrar Caja</button>
                <div id="status-indicator" class="w-4 h-4 rounded-full bg-red-500" title="Desconectado"></div>
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Columna de Pedidos Pendientes -->
            <div class="lg:col-span-2">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Pedidos Pendientes</h2>
                <div id="orders-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                    <!-- Los pedidos nuevos aparecerán aquí -->
                </div>
            </div>
            <!-- Columna de Resumen de Mesas -->
            <div>
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Resumen de Mesas</h2>
                <div id="tables-summary-container" class="space-y-4">
                    <!-- El resumen por mesa aparecerá aquí -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Cierre de Caja -->
    <div id="close-shift-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Resumen del Día</h2>
            <p class="text-lg mb-2">Total de Ventas: <span id="modal-total-sales" class="font-bold text-green-600"></span></p>
            <p class="text-lg mb-6">Total de Productos Vendidos: <span id="modal-total-items" class="font-bold"></span></p>
            <p class="text-gray-600 mb-4">Al confirmar, los pedidos completados se archivarán y el conteo del día se reiniciará. Esta acción no se puede deshacer.</p>
            <div class="flex justify-center gap-4">
                <button id="cancel-close-shift" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg">Cancelar</button>
                <button id="confirm-close-shift" class="bg-red-500 text-white font-bold py-2 px-6 rounded-lg">Confirmar Cierre</button>
            </div>
        </div>
    </div>

    <!-- Tone.js for sound -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, doc, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {
            if (typeof __firebase_config === 'undefined' || typeof __app_id === 'undefined') {
                console.error("Error: La configuración de Firebase no está disponible.");
                document.body.innerHTML = '<div class="text-center p-8 bg-red-100 text-red-700">Error: La configuración de Firebase no está disponible. No se pueden cargar los pedidos.</div>';
                return;
            }

            const firebaseConfig = JSON.parse(__firebase_config);
            const appId = __app_id;
            
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);

            const statusIndicator = document.getElementById('status-indicator');
            const ordersContainer = document.getElementById('orders-container');
            const tablesSummaryContainer = document.getElementById('tables-summary-container');
            const totalSalesEl = document.getElementById('total-sales');
            const closeShiftBtn = document.getElementById('close-shift-btn');
            const exportPdfBtn = document.getElementById('export-pdf-btn');
            const closeShiftModal = document.getElementById('close-shift-modal');
            
            let allTodaysOrders = [];

            const synth = new Tone.Synth().toDestination();
            function playNotificationSound() {
                if (Tone.context.state !== 'running') { Tone.start(); }
                synth.triggerAttackRelease("C5", "8n");
            }

            onAuthStateChanged(auth, user => {
                if (user) {
                    statusIndicator.classList.replace('bg-red-500', 'bg-green-500');
                    statusIndicator.title = 'Conectado';
                    listenForOrders();
                } else {
                    statusIndicator.classList.replace('bg-green-500', 'bg-red-500');
                    statusIndicator.title = 'Desconectado';
                }
            });

            signInAnonymously(auth).catch(error => console.error("Error al iniciar sesión:", error));

            function listenForOrders() {
                const ordersRef = collection(db, `/artifacts/${appId}/public/data/orders`);
                const q = query(ordersRef);

                onSnapshot(q, (snapshot) => {
                    let newOrderSound = false;
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === "added" && change.doc.data().status === 'pending') {
                            newOrderSound = true;
                        }
                    });

                    if (newOrderSound) {
                        playNotificationSound();
                    }
                    
                    allTodaysOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    updateDashboard();
                });
            }

            function updateDashboard() {
                ordersContainer.innerHTML = '';
                tablesSummaryContainer.innerHTML = '';
                let totalSales = 0;
                const tables = {};

                const todaysActiveOrders = allTodaysOrders.filter(order => order.status === 'pending' || order.status === 'completed');

                todaysActiveOrders.sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));

                todaysActiveOrders.forEach(order => {
                    if (order.status === 'pending') {
                        renderPendingOrder(order.id, order);
                    }

                    const price = order.price || 0;
                    totalSales += price;
                    if (!tables[order.table]) {
                        tables[order.table] = { items: 0, total: 0, customers: new Set() };
                    }
                    tables[order.table].items++;
                    tables[order.table].total += price;
                    tables[order.table].customers.add(order.customer);
                });

                totalSalesEl.textContent = `$${totalSales.toFixed(2)}`;
                exportPdfBtn.disabled = todaysActiveOrders.length === 0;
                
                Object.keys(tables).sort((a,b) => parseInt(a) - parseInt(b)).forEach(tableNum => {
                    const tableData = tables[tableNum];
                    const summaryCard = document.createElement('div');
                    summaryCard.className = 'bg-white p-4 rounded-lg shadow';
                    summaryCard.innerHTML = `
                        <div class="flex justify-between items-center">
                            <h3 class="text-xl font-bold">Mesa ${tableNum}</h3>
                            <div class="text-right">
                                <p class="font-bold text-lg text-green-600">$${tableData.total.toFixed(2)}</p>
                                <p class="text-sm text-gray-500">${tableData.items} producto(s)</p>
                            </div>
                        </div>
                        <p class="text-sm text-gray-500 mt-2">Clientes: ${Array.from(tableData.customers).join(', ')}</p>
                    `;
                    tablesSummaryContainer.appendChild(summaryCard);
                });
            }

            function renderPendingOrder(id, data) {
                const card = document.createElement('div');
                card.id = id;
                card.className = 'order-card new bg-white rounded-lg shadow-md p-5 flex flex-col';
                const time = data.timestamp ? new Date(data.timestamp.seconds * 1000).toLocaleTimeString() : 'Ahora';

                card.innerHTML = `
                    <div class="flex-grow">
                        <div class="flex justify-between items-baseline">
                            <h2 class="text-2xl font-bold text-gray-800">Mesa ${data.table}</h2>
                            <span class="text-sm text-gray-500">${time}</span>
                        </div>
                        <p class="text-lg text-gray-600 my-2">Cliente: <span class="font-semibold">${data.customer}</span></p>
                        <p class="text-lg text-gray-800 bg-yellow-100 p-2 rounded-md">Sabor: <span class="font-bold">${data.flavor}</span></p>
                    </div>
                    <button data-id="${id}" class="complete-btn mt-4 w-full bg-green-500 text-white font-bold py-2 rounded-lg hover:bg-green-600 transition-colors">Marcar como Despachado</button>
                `;
                ordersContainer.prepend(card);

                card.querySelector('.complete-btn').addEventListener('click', async (e) => {
                    const orderId = e.target.getAttribute('data-id');
                    const orderDocRef = doc(db, `/artifacts/${appId}/public/data/orders`, orderId);
                    await updateDoc(orderDocRef, { status: "completed" });
                });
            }

            function exportDailyReportPDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                const flavorSummary = {};
                let totalItems = 0;
                let totalSales = 0;

                const activeOrders = allTodaysOrders.filter(order => order.status === 'pending' || order.status === 'completed');

                activeOrders.forEach(order => {
                    if (!flavorSummary[order.flavor]) {
                        flavorSummary[order.flavor] = { quantity: 0, subtotal: 0 };
                    }
                    flavorSummary[order.flavor].quantity++;
                    flavorSummary[order.flavor].subtotal += order.price || 0;
                    totalItems++;
                    totalSales += order.price || 0;
                });

                const tableBody = Object.keys(flavorSummary).map(flavor => {
                    const data = flavorSummary[flavor];
                    return [flavor, data.quantity, `$${data.subtotal.toFixed(2)}`];
                });
                
                const today = new Date().toLocaleDateString('es-EC');
                const fileNameDate = new Date().toISOString().slice(0, 10);

                doc.setFontSize(20);
                doc.text("Reporte de Ventas - VALÚ Chocobananas", 105, 22, { align: 'center' });
                doc.setFontSize(12);
                doc.text(`Fecha: ${today}`, 105, 30, { align: 'center' });

                doc.autoTable({
                    head: [['Sabor', 'Cantidad Vendida', 'Subtotal']],
                    body: tableBody,
                    startY: 40,
                    headStyles: { fillColor: [61, 43, 31] }, 
                    theme: 'grid'
                });

                const finalY = doc.lastAutoTable.finalY + 10;
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text("Resumen General", 14, finalY);
                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                doc.text(`Total de Productos Vendidos: ${totalItems}`, 14, finalY + 8);
                doc.text(`Venta Total del Día: $${totalSales.toFixed(2)}`, 14, finalY + 16);

                doc.save(`Reporte_Valu_Chocobananas_${fileNameDate}.pdf`);
            }

            exportPdfBtn.addEventListener('click', exportDailyReportPDF);

            closeShiftBtn.addEventListener('click', () => {
                const activeOrders = allTodaysOrders.filter(order => order.status === 'completed' || order.status === 'pending');
                const total = activeOrders.reduce((sum, order) => sum + (order.price || 0), 0);
                const items = activeOrders.length;
                document.getElementById('modal-total-sales').textContent = `$${total.toFixed(2)}`;
                document.getElementById('modal-total-items').textContent = items;
                closeShiftModal.classList.add('visible');
            });

            document.getElementById('cancel-close-shift').addEventListener('click', () => closeShiftModal.classList.remove('visible'));

            document.getElementById('confirm-close-shift').addEventListener('click', async () => {
                const batch = writeBatch(db);
                const ordersToArchive = allTodaysOrders.filter(order => order.status === 'completed');
                
                ordersToArchive.forEach(order => {
                    const orderDocRef = doc(db, `/artifacts/${appId}/public/data/orders`, order.id);
                    batch.update(orderDocRef, { status: "archived" });
                });
                
                await batch.commit();
                console.log("Caja cerrada y pedidos archivados.");
                closeShiftModal.classList.remove('visible');
            });
        });
    </script>
</body>
</html>
