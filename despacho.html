<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pedidos en Vivo - VALÚ Chocobananas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f3f4f6; }
        .order-card { transition: all 0.3s ease; }
        .order-card.new { animation: fadeIn 0.5s ease; }
        .order-card.completed { background-color: #d1fae5; opacity: 0.6; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <div class="flex items-center justify-between mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Pedidos en Tiempo Real</h1>
            <div id="status-indicator" class="w-4 h-4 rounded-full bg-red-500" title="Desconectado"></div>
        </div>
        
        <!-- Contenedor de Pedidos -->
        <div id="orders-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <!-- Los pedidos nuevos aparecerán aquí -->
        </div>
    </div>

    <!-- Tone.js for sound -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuración de Firebase ---
        // Se añade una comprobación para asegurar que las variables de configuración existen
        if (typeof __firebase_config === 'undefined' || typeof __app_id === 'undefined') {
            console.error("Error: La configuración de Firebase no está disponible. Asegúrate de que el entorno esté configurado correctamente.");
        } else {
            const firebaseConfig = JSON.parse(__firebase_config);
            const appId = __app_id;
            
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);

            const statusIndicator = document.getElementById('status-indicator');
            const ordersContainer = document.getElementById('orders-container');

            // --- Sonido de Notificación ---
            const synth = new Tone.Synth().toDestination();
            function playNotificationSound() {
                if (Tone.context.state !== 'running') {
                    Tone.start();
                }
                synth.triggerAttackRelease("C5", "8n");
            }

            // --- Lógica de la Pantalla de Despacho ---
            let isFirstLoad = true;
            const knownOrderIds = new Set(); 

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    statusIndicator.classList.remove('bg-red-500');
                    statusIndicator.classList.add('bg-green-500');
                    statusIndicator.title = 'Conectado';
                    listenForOrders();
                } else {
                    statusIndicator.classList.add('bg-red-500');
                    statusIndicator.classList.remove('bg-green-500');
                    statusIndicator.title = 'Desconectado';
                }
            });

            async function signIn() {
                if (auth.currentUser) return;
                try {
                    await signInAnonymously(auth);
                } catch (error) {
                    console.error("Error al iniciar sesión:", error);
                }
            }

            function listenForOrders() {
                const ordersRef = collection(db, `/artifacts/${appId}/public/data/orders`);
                const q = query(ordersRef);

                onSnapshot(q, (snapshot) => {
                    const pendingOrders = [];
                    snapshot.forEach(doc => {
                        if (doc.data().status === "pending") {
                            pendingOrders.push({ id: doc.id, ...doc.data() });
                        }
                    });

                    pendingOrders.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

                    let newOrderFound = false;
                    pendingOrders.forEach(order => {
                        if (!knownOrderIds.has(order.id)) {
                            newOrderFound = true;
                            knownOrderIds.add(order.id);
                        }
                    });

                    if (newOrderFound && !isFirstLoad) {
                        playNotificationSound();
                    }

                    ordersContainer.innerHTML = '';
                    pendingOrders.forEach(order => {
                        renderOrder(order.id, order);
                    });

                    isFirstLoad = false;
                });
            }

            function renderOrder(id, data) {
                const card = document.createElement('div');
                card.id = id;
                card.className = 'order-card new bg-white rounded-lg shadow-md p-5 flex flex-col';
                
                const time = data.timestamp ? new Date(data.timestamp.seconds * 1000).toLocaleTimeString() : 'Ahora';

                card.innerHTML = `
                    <div class="flex-grow">
                        <div class="flex justify-between items-baseline">
                            <h2 class="text-2xl font-bold text-gray-800">Mesa ${data.table}</h2>
                            <span class="text-sm text-gray-500">${time}</span>
                        </div>
                        <p class="text-lg text-gray-600 my-2">Cliente: <span class="font-semibold">${data.customer}</span></p>
                        <p class="text-lg text-gray-800 bg-yellow-100 p-2 rounded-md">Sabor: <span class="font-bold">${data.flavor}</span></p>
                    </div>
                    <button data-id="${id}" class="complete-btn mt-4 w-full bg-green-500 text-white font-bold py-2 rounded-lg hover:bg-green-600 transition-colors">Marcar como Despachado</button>
                `;

                ordersContainer.appendChild(card);

                card.querySelector('.complete-btn').addEventListener('click', async (e) => {
                    const orderId = e.target.getAttribute('data-id');
                    const orderDocRef = doc(db, `/artifacts/${appId}/public/data/orders`, orderId);
                    await updateDoc(orderDocRef, { status: "completed" });
                });
            }

            signIn();
        }
    </script>
</body>
</html>
